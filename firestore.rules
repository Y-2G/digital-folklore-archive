rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // Helper function to check if document is published
    function isPublished() {
      return resource.data.status == "PUBLISHED";
    }

    // Items collection
    match /items/{itemId} {
      // Public can read published items
      allow read: if isPublished();

      // Only admins can write
      allow create, update, delete: if isAdmin();

      // Revisions subcollection
      match /revisions/{revisionId} {
        // Public can read revisions of published items
        allow read: if get(/databases/$(database)/documents/items/$(itemId)).data.status == "PUBLISHED";

        // Only admins can write
        allow write: if isAdmin();
      }

      // Annotations subcollection
      match /annotations/{annotationId} {
        // Public can read annotations of published items
        allow read: if get(/databases/$(database)/documents/items/$(itemId)).data.status == "PUBLISHED";

        // Only admins can write
        allow write: if isAdmin();
      }
    }

    // Collections (curated shelves)
    match /collections/{collectionSlug} {
      // Public can read published collections
      allow read: if isPublished();

      // Only admins can write
      allow write: if isAdmin();
    }

    // User submissions (for future use)
    match /submissions/{submissionId} {
      // Users can create submissions (authenticated)
      allow create: if request.auth != null;

      // Users can read their own submissions
      allow read: if request.auth != null && request.auth.uid == resource.data.submittedBy;

      // Only admins can update/delete
      allow update, delete: if isAdmin();
    }

    // Counters for statistics (for future use)
    match /counters/{counterId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
